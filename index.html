<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fullpage TB/T/B/F/TBb mit automatischem Menü & Hintergrund</title>
<style>
html,body{
    margin:0; padding:0;
    width:calc(var(--vw, 1vw) * 100);
    height:calc(var(--vh, 1vh) * 100);
    font-family:sans-serif; font-weight:300;
    color:rgba(255,255,255,0.7);
    box-sizing:border-box;
    overflow-y:hidden;
    scroll-snap-type:y mandatory;
    scroll-behavior:smooth;
    background:black;
}
#bg-frame{
    position:fixed; top:0; left:0;
    width:calc(var(--vw, 1vw) * 100);
    height:calc(var(--vh, 1vh) * 100);
    border:none; z-index:0;
    pointer-events:auto;
    transition:opacity 0.5s ease;
}
header{
    position:fixed; top:0; left:0;
    width:calc(var(--vw, 1vw) * 100);
    height:60px;
    display:flex; justify-content:flex-start; align-items:center;
    padding:0 1rem; z-index:10;
}
header .logo{
    font-weight:300; font-size:1rem;
    cursor:pointer; color:rgba(255,255,255,0.7);
    margin:0; padding:0;
}
.menu-overlay {
    position:fixed; top:0; left:0;
    width:calc(var(--vw, 1vw) * 100);
    height:calc(var(--vh, 1vh) * 100);
    background:rgba(0,0,0,0.9); backdrop-filter:blur(14px);
    display:flex; flex-direction:column; justify-content:center; align-items:center; gap:1rem;
    z-index:20; opacity:0; pointer-events:none; transition:opacity 0.5s ease;
}
.menu-overlay.show { opacity:1; pointer-events:auto; }
.menu-overlay a {
    color:white; text-decoration:none; font-weight:300; font-size:1.5rem;
    text-align:center; opacity:0; transition:opacity 0.5s ease;
}
.menu-overlay a.show { opacity:1; }
.menu-overlay a:hover { background:rgba(255,255,255,0.1); border-radius:6px; padding:0.5rem 1rem; }

/* Sections und Boxen */
section{
    position:relative;
    height:calc(var(--vh, 1vh) * 100);
    pointer-events:none; scroll-snap-align:start;
}
.blur-box{
    box-sizing:border-box;
    width:calc(var(--vw, 1vw) * 100);
    pointer-events:auto; overflow-y:auto;
    padding:0; margin:0; position:relative;
}
.blur-box.bottom{ max-height:35vh; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px);
    display:flex; flex-direction:row; overflow:hidden; padding:0; margin:0;
}
.blur-box.fullscreen{ height:100%; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px);
    display:flex; justify-content:flex-start; align-items:flex-end; flex-direction:column; padding:1rem; margin:0;
}
.blur-box.fullscreen-image{ height:100%; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; overflow:hidden; margin:0; }
.fullscreen-media{ flex:1; width:calc(var(--vw, 1vw) * 100); display:flex; justify-content:center; align-items:center; overflow:hidden; }
.fullscreen-media img,.fullscreen-media iframe{ width:100%; height:100%; object-fit:cover; }
.blur-bottom-text{ width:calc(var(--vw, 1vw) * 100); background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); padding:1rem; box-sizing:border-box; text-align:left; }
.text-content{ 
    padding:1rem; white-space:pre-wrap; 
    color:rgba(255,255,255,0.7); 
    font-weight:300; font-size:0.95rem; max-width:100%; overflow-y:auto; 
    pointer-events:auto; margin:0; position:relative;
    background: linear-gradient(to bottom, rgba(0,0,0,0.0), rgba(0,0,0,0.0));
}
.text-content *{ pointer-events:auto; }
.text-content::-webkit-scrollbar{display:none;}
.text-content h2{ font-size:1.6rem; margin:0 0 0.5rem 0; font-weight:300; }
.text-content p{ font-size:0.85rem; margin:0; line-height:1.4; }
.text-content::after{
    content:""; position:absolute; bottom:0; left:0; width:100%; height:2rem;
    background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.6));
    pointer-events:none;
}
.image-content{ width:50vw; height:100%; overflow:hidden; flex-shrink:0; pointer-events:none; }
.image-content img{ width:100%; height:100%; object-fit:cover; }
.blur-box.TBb{ height:100%; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; overflow:hidden; margin:0; }
.TBb-fullscreen{ flex:1; width:calc(var(--vw, 1vw) * 100); display:flex; justify-content:center; align-items:center; overflow:hidden; margin:0; }
.TBb-fullscreen img{ width:100%; height:100%; object-fit:cover; }
.TBb-bottom{ max-height:35vh; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); display:flex; flex-direction:row; overflow:hidden; margin:0; }
.B-grid{ width:calc(var(--vw, 1vw) * 100); height:100%; display:grid; grid-template-columns:1fr 1fr; grid-auto-rows:calc(100%/3); margin:0; }
.B-grid img{ width:100%; height:100%; object-fit:cover; display:block; }
@media(max-width:767px){
    .blur-box.bottom{flex-direction:column; max-height:50vh;}
    .text-content{width:100%; max-height:20vh; font-size:0.8rem; overflow-y:auto;}
    .image-content{width:100%; height:35vh;}
}
</style>
</head>
<body>

<iframe id="bg-frame" src="https://paulkimmerl.github.io/tunnel/" allow="autoplay; fullscreen"></iframe>

<header>
    <div class="logo" id="menuToggle">paul kimmerl</div>
</header>

<div class="menu-overlay" id="menu"></div>
<div class="container-wrapper" id="container-wrapper"></div>

<script>
// Viewport Fix für exakte Pixelgröße
function setViewport() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
  document.documentElement.style.setProperty('--vw', `${window.innerWidth * 0.01}px`);
}
window.addEventListener('resize', setViewport);
setViewport();

// Automatisches Menü
const menuEl = document.getElementById("menu");
const toggleBtn = document.getElementById("menuToggle");
toggleBtn.addEventListener("click", ()=>{
    menuEl.classList.toggle('show');
    window.scrollTo({top:0, behavior:"instant"});
});
document.addEventListener('click', e=>{
    if(menuEl.classList.contains('show') && !menuEl.contains(e.target) && e.target!==toggleBtn){
        menuEl.classList.remove('show');
    }
});

// Content-Dateien automatisch
const contentFiles = [];
for(let i=0;i<100;i++){
    contentFiles.push(i===0 ? 'content.txt' : `content${i}.txt`);
}

// Menü laden
async function loadMenu(){
    menuEl.innerHTML="";
    for(let f of contentFiles){
        try{
            const res = await fetch(f); if(!res.ok) continue;
            const text = await res.text();
            const firstLine = text.split("\n")[0].trim() || f;
            const a = document.createElement("a"); a.textContent=firstLine; a.href="#"; 
            menuEl.appendChild(a);
        }catch(e){ console.warn(e); }
    }
    [...menuEl.children].forEach((link,i)=>{
        setTimeout(()=>link.classList.add('show'), i*100);
        link.addEventListener("click", e=>{
            e.preventDefault(); 
            menuEl.classList.remove('show');
            window.scrollTo({top:0, behavior:"instant"});
            loadContentFromFile(contentFiles[i]);
            loadBackgroundFromContent(contentFiles[i]);
            history.replaceState(null,null,"#"+contentFiles[i]);
        });
    });
}
loadMenu();

// Hintergrund laden
async function loadBackgroundFromContent(filename){
    const defaultBg = "https://paulkimmerl.github.io/tunnel/";
    try{
        const res = await fetch(filename); if(!res.ok) throw "no file";
        let content = await res.text();
        const lines = content.split("\n");
        const bgIndex = lines.findIndex(l => l.startsWith(">>"));
        const bgUrl = (bgIndex>=0) ? lines[bgIndex].replace(/^>>/, "").trim() : defaultBg;
        const iframe = document.getElementById("bg-frame");
        iframe.style.opacity = 0;
        setTimeout(()=>{ iframe.src=bgUrl; iframe.style.opacity=1; },300);
    }catch(err){
        const iframe = document.getElementById("bg-frame");
        iframe.style.opacity = 0;
        setTimeout(()=>{ iframe.src=defaultBg; iframe.style.opacity=1; },300);
    }
}

// Media helper
function extractMedia(text){ 
    const imgs = [...text.matchAll(/\/\/\s*(.+\.(png|jpg|jpeg|gif|webp))/gi)].map(m=>m[1]);
    const cleanedText = text.replace(/\/\/\s*.+\.(png|jpg|jpeg|gif|webp)/gi,'').replace(/https?:\/\/\S+/gi,'');
    return {imgs, cleanedText};
}

// Container erstellen mit <<Link
function createContainer(type,text){
    if(!text) return;

    let linkUrl = null;
    const linkMatch = text.match(/<<\s*(\S+)/);
    if(linkMatch){
        linkUrl = linkMatch[1].trim();
        text = text.replace(linkMatch[0],'');
    }

    const bgMatch = text.match(/>>\s*(.+)/);
    if(bgMatch){ text=text.replace(bgMatch[0],''); }

    const containerWrapper = document.getElementById('container-wrapper');
    const section = document.createElement('section');
    section.style.position="relative";
    section.style.height="calc(var(--vh, 1vh) * 100)";
    section.style.pointerEvents="none";

    if(linkUrl){
        section.style.cursor="pointer";
        section.addEventListener('click',()=>{ window.open(linkUrl,'_blank'); });
    }

    let box;
    if(type==='TB'){ box=document.createElement('div'); box.className='blur-box bottom'; }
    else if(type==='T'||type==='B'){ box=document.createElement('div'); box.className='blur-box fullscreen'; }
    else if(type==='F'){ box=document.createElement('div'); box.className='blur-box fullscreen-image'; }
    else if(type==='TBb'){ box=document.createElement('div'); box.className='blur-box TBb'; }

    box.style.position="absolute"; box.style.bottom="0"; box.style.pointerEvents="auto";

    const media = extractMedia(text);
    const textDiv=document.createElement('div'); 
    textDiv.className='text-content';
    textDiv.innerHTML = media.cleanedText.replace(/\*(.*?)\*/g,'<h2>$1</h2>').replace(/\n/g,'<br>');

    if(type==='TB'){
        if(media.imgs.length){
            const imgDiv=document.createElement('div'); imgDiv.className='image-content';
            const img=document.createElement('img'); img.src=media.imgs[0]; imgDiv.appendChild(img);
            box.appendChild(textDiv); box.appendChild(imgDiv);
        } else { box.appendChild(textDiv); }
    } else if(type==='T'){
        box.appendChild(textDiv);
        box.style.justifyContent = "flex-end";
        box.style.alignItems = "flex-start";
    } else if(type==='B' && media.imgs.length){
        const gridDiv=document.createElement('div'); gridDiv.className='B-grid';
        media.imgs.forEach(src=>{ const img=document.createElement('img'); img.src=src; gridDiv.appendChild(img); });
        box.appendChild(gridDiv);
    } else if(type==='F'){
        const mediaDiv=document.createElement('div'); mediaDiv.className='fullscreen-media';
        if(media.imgs[0]){ const img=document.createElement('img'); img.src=media.imgs[0]; mediaDiv.appendChild(img); }
        box.appendChild(mediaDiv);
        const bottomText=document.createElement('div'); bottomText.className='blur-bottom-text';
        bottomText.innerHTML=textDiv.innerHTML; box.appendChild(bottomText);
    } else if(type==='TBb'){
        const topDiv=document.createElement('div'); topDiv.className='TBb-fullscreen';
        if(media.imgs[0]){ const img=document.createElement('img'); img.src=media.imgs[0]; topDiv.appendChild(img); }
        box.appendChild(topDiv);
        const bottomDiv=document.createElement('div'); bottomDiv.className='TBb-bottom';
        const bottomText=document.createElement('div'); bottomText.className='text-content';
        bottomText.innerHTML=textDiv.innerHTML; bottomDiv.appendChild(bottomText);
        if(media.imgs[1]){
            const imgDiv=document.createElement('div'); imgDiv.className='image-content';
            const img=document.createElement('img'); img.src=media.imgs[1]; imgDiv.appendChild(img);
            bottomDiv.appendChild(imgDiv);
        }
        box.appendChild(bottomDiv);
    }

    section.appendChild(box);
    containerWrapper.appendChild(section);
}

// Content laden
async function loadContentFromFile(filename){
    try{
        const res = await fetch(filename); if(!res.ok) return;
        const contentInput = await res.text();
        const containerWrapper = document.getElementById('container-wrapper');
        containerWrapper.innerHTML="";
        const containerRegex = /#\d+(TB|T|B|F|TBb)?/g;
        let matches,lastIndex=0,prevType;
        while((matches=containerRegex.exec(contentInput))!==null){
            const type = matches[1] || 'TB';
            const startIndex = matches.index;
            if(lastIndex!==0){
                let text = contentInput.slice(lastIndex,startIndex).trim();
                if(text) createContainer(prevType,text);
            }
            prevType = type;
            lastIndex = containerRegex.lastIndex;
        }
        const lastText = contentInput.slice(lastIndex).trim();
        if(lastText) createContainer(prevType,lastText);
        loadBackgroundFromContent(filename);
        history.replaceState(null,null,"#"+filename);
        window.scrollTo({top:0, behavior:"instant"});
    } catch(e){ console.error("Fehler beim Laden von "+filename,e); }
}

// Body Scroll: immer erlaubt, TB scrollbar intern
function updateBodyScroll(e){
    document.body.style.overflowY="auto";
}
document.addEventListener('mousemove', updateBodyScroll);
document.addEventListener('touchstart', updateBodyScroll);

loadContentFromFile('content.txt');
</script>
</body>
</html>
