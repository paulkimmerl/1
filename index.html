<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fullpage mit neuem #B-System & Overlay</title>
<style>
html, body {
    margin:0; padding:0;
    width:100vw; height:100vh;
    font-family:sans-serif; font-weight:300;
    color:rgba(255,255,255,0.7);
    box-sizing:border-box;
    overflow-y:hidden; /* Wird per JS gesteuert */
    overflow-x:hidden;
    scroll-snap-type:y mandatory;
    scroll-behavior:smooth; /* Smooth Scroll aktiv */
}
* { scrollbar-width: none; }
*::-webkit-scrollbar { display: none; }

#bg-frame{ position:fixed; top:0; left:0; width:100vw; height:100vh; border:none; z-index:0; pointer-events:auto; transition:opacity 0.7s ease; }

header{
    position:fixed; top:10px; left:0; width:100vw; height:60px; display:flex; justify-content:flex-start; align-items:flex-start; padding:0 1rem; z-index:10;
}
header .logo{ font-weight:300; font-size:1rem; cursor:pointer; color:rgba(255,255,255,0.7); }

.menu-overlay { 
    position:fixed; top:0; left:0; width:100vw; height:100vh; 
    background:rgba(0,0,0,0.9); backdrop-filter:blur(14px); 
    display:flex; flex-direction:column; justify-content:center; align-items:center; gap:1rem; 
    z-index:20; opacity:0; pointer-events:none; transition:opacity 0.5s ease; 
}
.menu-overlay.show { opacity:1; pointer-events:auto; }
.menu-overlay a { 
    color:rgba(255,255,255,0.7); 
    text-decoration:none; 
    font-weight:300; 
    font-size:0.95rem; 
    text-align:center; 
    transition:color 0.3s ease; 
}
.menu-overlay a:hover { color:rgba(255,255,255,0.9); }

section{ position:relative; height:100vh; pointer-events:none; scroll-snap-align:start; }
.blur-box{ box-sizing:border-box; width:100vw; pointer-events:auto; overflow:auto; padding:0; margin:0; position:relative; }
.blur-box.bottom{ max-height:35vh; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); display:flex; flex-direction:row; overflow:hidden; margin:0; }
.blur-box.fullscreen{ height:100%; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); display:flex; justify-content:flex-start; align-items:flex-end; flex-direction:column; padding:1rem; margin:0; }
.blur-box.fullscreen-image{ height:100%; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; overflow:hidden; margin:0; }
.fullscreen-media{ flex:1; width:100vw; display:flex; justify-content:center; align-items:center; overflow:hidden; }
.fullscreen-media img,.fullscreen-media iframe{ width:100%; height:100%; object-fit:cover; border:none; }
.blur-bottom-text{ width:100vw; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); padding:1rem; box-sizing:border-box; text-align:left; }

.text-content{ padding:1rem; white-space:pre-wrap; color:rgba(255,255,255,0.7); font-weight:300; font-size:0.95rem; max-width:100%; overflow-y:auto; pointer-events:auto; margin:0; position:relative; mask-image: linear-gradient(to bottom, black 60%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 60%, transparent 100%); }
.text-content *{ pointer-events:auto; }
.text-content::-webkit-scrollbar{display:none;}
.text-content h2{ font-size:1.6rem; margin:0 0 0.5rem 0; font-weight:300; }
.text-content p{ font-size:0.85rem; margin:0; line-height:1.4; }

.image-content{ width:50vw; height:100%; overflow:hidden; flex-shrink:0; pointer-events:none; }
.image-content img{ width:100%; height:100%; object-fit:cover; }

.blur-box.TBb{ height:100%; display:flex; flex-direction:column; justify-content:flex-start; align-items:center; overflow:hidden; margin:0; }
.TBb-fullscreen{ flex:1; width:100vw; display:flex; justify-content:center; align-items:center; overflow:hidden; margin:0; }
.TBb-fullscreen img{ width:100%; height:100%; object-fit:cover; }
.TBb-bottom{ max-height:35vh; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); display:flex; flex-direction:row; overflow:hidden; margin:0; }

.F-top{ width:100vw; height:70vh; display:flex; justify-content:center; align-items:center; overflow:hidden; }
.F-top iframe,.F-top img,.F-top video{ width:100%; height:100%; object-fit:cover; border:none; pointer-events:auto; }
.F-bottom{ width:100vw; max-height:30vh; background:rgba(255,255,255,0.12); backdrop-filter:blur(6px); overflow:auto; }

/* Responsive TB/TBL */
@media(max-width:767px){
    .blur-box.bottom, .TBb-bottom{ flex-direction:column; max-height:50vh; }
    .text-content{ width:100%; max-height:20vh; font-size:0.8rem; overflow-y:auto; }
    .image-content{ width:100%; height:35vh; }
}
</style>
</head>
<body>

<iframe id="bg-frame" src="" allow="autoplay; fullscreen"></iframe>

<header>
    <div class="logo" id="menuToggle">paul kimmerl</div>
</header>

<div class="menu-overlay" id="menu"></div>
<div class="container-wrapper" id="container-wrapper"></div>

<script>
// Overlay Menü
const menuEl = document.getElementById("menu");
const toggleBtn = document.getElementById("menuToggle");
toggleBtn.addEventListener("click", ()=>{
    menuEl.classList.toggle('show'); 
    window.scrollTo({top:0, behavior:"smooth"}); // Smooth
});
menuEl.addEventListener("click", e => { if (e.target === menuEl) menuEl.classList.remove("show"); });

// Media Helper
function extractMedia(text){ 
    const imgs = [...text.matchAll(/\/\/\s*(.+\.(png|jpg|jpeg|gif|webp|mp4))/gi)].map(m=>m[1]);
    const embeds = [...text.matchAll(/&&\s*(\S+)/gi)].map(m=>m[1]);
    const cleanedText = text.replace(/\/\/\s*.+\.(png|jpg|jpeg|gif|webp|mp4)/gi,'').replace(/&&\s*\S+/gi,'').replace(/https?:\/\/\S+/gi,'');
    return {imgs, embeds, cleanedText};
}

// Media Element
function createMediaEl(src){
    if(src.endsWith('.mp4')){
        const vid=document.createElement('video'); vid.src=src; vid.autoplay=true; vid.loop=true; vid.muted=true; vid.playsInline=true; vid.style.width='100%'; vid.style.height='100%'; vid.style.objectFit='cover'; vid.style.border='none'; return vid;
    } else if(src.match(/youtube|vimeo/)){
        const iframe=document.createElement('iframe'); 
        iframe.src=src.replace("watch?v=","embed/")+"?autoplay=1&mute=1&loop=1&playlist="+src.split("v=")[1]; 
        iframe.allow="autoplay; fullscreen"; iframe.allowFullscreen=true; 
        iframe.style.width='100%'; iframe.style.height='100%'; iframe.style.objectFit='cover'; iframe.style.border='none'; 
        return iframe;
    } else { 
        const img=document.createElement('img'); img.src=src; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; img.style.border='none'; return img; 
    }
}

// Container erstellen
function createContainer(type,text,currentBg){
    if(!text) return;
    let linkUrl = null;
    const linkMatch = text.match(/<<\s*(\S+)/);
    if(linkMatch){ linkUrl = linkMatch[1].trim(); text = text.replace(linkMatch[0],''); }
    const sectionBgMatch = text.match(/>>\s*(.+)/);
    if(sectionBgMatch){ currentBg = sectionBgMatch[1].trim(); text = text.replace(sectionBgMatch[0],''); }

    const containerWrapper = document.getElementById('container-wrapper');
    const section = document.createElement('section');
    section.dataset.bg = currentBg;
    section.style.position="relative"; section.style.height="100vh"; section.style.pointerEvents="none";
    if(linkUrl){ section.style.cursor="pointer"; section.addEventListener('click',()=>{ window.open(linkUrl,'_blank'); }); }

    const media = extractMedia(text);
    const textDiv=document.createElement('div'); 
    textDiv.className='text-content';
    textDiv.innerHTML = media.cleanedText.replace(/\*(.*?)\*/g,'<h2>$1</h2>').replace(/\n/g,'<br>');

    // --- B Sektion überarbeitet: Body scroll aktiv, Section scroll deaktiviert ---
    if(type==='B'){ 
        document.body.style.overflowY='auto'; // Body-Scroll aktiv

        const box=document.createElement('div'); 
        box.style.width="100vw"; 
        box.style.height="100vh"; 
        box.style.position="relative"; 
        box.style.display="flex"; 
        box.style.flexWrap="wrap"; 
        box.style.alignItems="stretch"; 
        box.style.justifyContent="stretch"; 
        box.style.overflow="visible"; // Box selbst scrollt nicht

        const allMedia=[...media.imgs,...media.embeds].slice(0,4);

        if(allMedia.length===1){
            const div=document.createElement('div');
            div.style.width='100%'; div.style.height='100%';
            div.appendChild(createMediaEl(allMedia[0]));
            box.appendChild(div);
        }
        else if(allMedia.length===2){
            allMedia.forEach(src=>{
                const div=document.createElement('div');
                div.style.width='50%'; div.style.height='100%';
                div.appendChild(createMediaEl(src));
                box.appendChild(div);
            });
        }
        else if(allMedia.length===3){
            for(let i=0;i<2;i++){
                const div=document.createElement('div');
                div.style.width='50%'; div.style.height='50%';
                div.appendChild(createMediaEl(allMedia[i]));
                box.appendChild(div);
            }
            const div=document.createElement('div');
            div.style.width='100%'; div.style.height='50%';
            div.appendChild(createMediaEl(allMedia[2]));
            box.appendChild(div);
        }
        else if(allMedia.length===4){
            allMedia.forEach(src=>{
                const div=document.createElement('div');
                div.style.width='50%'; div.style.height='50%';
                div.appendChild(createMediaEl(src));
                box.appendChild(div);
            });
        }

        if(media.cleanedText){
            const textDivSimple = document.createElement('div');
            textDivSimple.className='text-content';
            textDivSimple.innerHTML = media.cleanedText.replace(/\*(.*?)\*/g,'<h2>$1</h2>').replace(/\n/g,'<br>');
            textDivSimple.style.position='absolute';
            textDivSimple.style.bottom='0';
            textDivSimple.style.left='0';
            textDivSimple.style.width='100%';
            textDivSimple.style.background='rgba(0,0,0,0.3)';
            textDivSimple.style.padding='1rem';
            textDivSimple.style.boxSizing='border-box';
            box.appendChild(textDivSimple);
        }

        section.appendChild(box);
        section.style.pointerEvents="auto";
    }
    else if(type==='TB'){
        const box=document.createElement('div'); box.className='blur-box bottom'; box.style.position="absolute"; box.style.bottom="0"; box.style.pointerEvents="auto";
        box.appendChild(textDiv.cloneNode(true));
        if(media.imgs[0]){
            const imgDiv=document.createElement('div'); imgDiv.className='image-content';
            imgDiv.appendChild(createMediaEl(media.imgs[0]));
            box.appendChild(imgDiv);
        }
        section.appendChild(box);
    }
    else if(type==='TBb'){
        const box=document.createElement('div'); box.className='blur-box TBb';
        const topDiv=document.createElement('div'); topDiv.className='TBb-fullscreen';
        if(media.imgs[0]) topDiv.appendChild(createMediaEl(media.imgs[0]));
        box.appendChild(topDiv);
        const bottomDiv=document.createElement('div'); bottomDiv.className='TBb-bottom';
        const bottomText=document.createElement('div'); bottomText.className='text-content';
        bottomText.innerHTML = textDiv.innerHTML;
        bottomDiv.appendChild(bottomText);
        if(media.imgs[1]){
            const imgDiv=document.createElement('div'); imgDiv.className='image-content';
            imgDiv.appendChild(createMediaEl(media.imgs[1]));
            bottomDiv.appendChild(imgDiv);
        }
        box.appendChild(bottomDiv);
        section.appendChild(box);
    }
    else if(type==='T'){ const box=document.createElement('div'); box.className='blur-box fullscreen'; box.appendChild(textDiv); box.style.justifyContent="flex-end"; box.style.alignItems="flex-start"; section.appendChild(box); }
    else if(type==='F'){ const top=document.createElement('div'); top.className='F-top'; [...media.imgs,...media.embeds].forEach(src=>{ top.appendChild(createMediaEl(src)); }); const bottom=document.createElement('div'); bottom.className='F-bottom'; bottom.appendChild(textDiv); section.appendChild(top); section.appendChild(bottom); }

    containerWrapper.appendChild(section);
}

// Content laden
async function loadContentFromFile(filename){
    try{
        const res=await fetch(filename); if(!res.ok) return;
        const contentInput=await res.text();
        const containerWrapper=document.getElementById('container-wrapper'); containerWrapper.innerHTML="";

        let globalBg="https://paulkimmerl.github.io/tunnel/";
        const initMatch=contentInput.match(/^>>\s*(.+)/m);
        if(initMatch) globalBg=initMatch[1].trim();

        let currentBg=globalBg;
        const containerRegex=/#\d+(TB|T|B|F|TBb)?/g;
        let matches,lastIndex=0,prevType;

        while((matches=containerRegex.exec(contentInput))!==null){
            const type=matches[1]||'TB';
            const startIndex=matches.index;
            if(lastIndex!==0){
                let text=contentInput.slice(lastIndex,startIndex).trim();
                if(text) createContainer(prevType,text,currentBg);
            }
            prevType=type;
            lastIndex=containerRegex.lastIndex;
        }

        const lastText=contentInput.slice(lastIndex).trim();
        if(lastText) createContainer(prevType,lastText,currentBg);

        // Hintergrund
        setupBackgroundUpdate(globalBg);

        history.replaceState(null,null,"#"+filename);
        window.scrollTo({top:0, behavior:"smooth"}); // Smooth
    }catch(e){console.error("Fehler beim Laden von "+filename,e);}
}

// Hintergrund-Update
function setupBackgroundUpdate(globalBg){
    const bgFrame=document.getElementById("bg-frame");
    const sections=document.querySelectorAll("section");
    const observer=new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
            if(entry.isIntersecting){
                const bg=entry.target.dataset.bg||globalBg;
                bgFrame.style.opacity=0;
                setTimeout(()=>{ bgFrame.src=bg; bgFrame.style.opacity=1; },50);
            }
        });
    },{threshold:0.5});
    sections.forEach(s=>observer.observe(s));
}

// Automatisches Menü
const contentFiles=[]; for(let i=0;i<100;i++){ contentFiles.push(i===0 ? 'content.txt' : `content${i}.txt`); }

async function loadMenu(){
    menuEl.innerHTML="";
    for(let f of contentFiles){
        try{
            const res=await fetch(f); if(!res.ok) continue;
            const text=await res.text();
            const firstLine=text.split("\n")[0].trim()||f;
            const a=document.createElement("a"); a.textContent=firstLine; a.href="#"; menuEl.appendChild(a);
        }catch(e){ console.warn(e);}
    }
    [...menuEl.children].forEach((link,i)=>{ 
        link.addEventListener("click", e=>{
            e.preventDefault(); 
            menuEl.classList.remove('show'); 
            loadContentFromFile(contentFiles[i]); 
            window.scrollTo({top:0, behavior:"smooth"}); // Smooth
            history.replaceState(null,null,"#"+contentFiles[i]); 
        }); 
    });
}
loadMenu();

// Scrollsteuerung nur über Text/Blur (optional)
function updateBodyScroll(e) {
    document.body.style.overflowY = 'auto';
}
document.body.addEventListener('mousemove', updateBodyScroll);
document.body.addEventListener('touchstart', updateBodyScroll);

loadContentFromFile('content.txt');
</script>
</body>
</html>
